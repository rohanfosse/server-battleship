<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Battleship Matchmaking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .timer-bar { height: 8px; background-color: #dc3545; transition: width 1s linear; }
    .match-request .timer-container { background-color: #f8d7da; border-radius: 4px; overflow: hidden; margin-top: 5px; }
    .player-tag.online { color: green; font-weight: bold; }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="text-center mb-4">ðŸŽ¯ Battleship Matchmaking Center</h1>

  <!-- Tabs -->
  <ul class="nav nav-tabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-players">Players</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pending">Pending Matches</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-scores">Scores</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-history">Match History</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-stats">Global Stats</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-help">Help</button></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Players -->
    <div class="tab-pane fade show active" id="tab-players">
      <h4>Connected Players</h4>
      <div id="players-list" class="list-group"></div>
    </div>

    <!-- Pending Matches -->
    <div class="tab-pane fade" id="tab-pending">
      <h4>Pending Matches</h4>
      <div id="pending-list" class="list-group mb-3"></div>
    </div>

    <!-- Scores -->
    <div class="tab-pane fade" id="tab-scores">
      <h4>Leaderboard</h4>
      <div id="scores-list" class="list-group"></div>
    </div>

    <!-- History -->
    <div class="tab-pane fade" id="tab-history">
      <h4>Recent Matches</h4>
      <div id="history-list" class="list-group"></div>
    </div>

    <!-- Stats -->
    <div class="tab-pane fade" id="tab-stats">
      <h4>Game Statistics</h4>
      <div id="global-stats" class="list-group"></div>
    </div>

    <!-- Help -->
    <div class="tab-pane fade" id="tab-help">
      <h4>How to Play</h4>
      <ul>
        <li>Start your <code>local_server.py</code> script.</li>
        <li>Your name will appear in the "Players" tab automatically.</li>
        <li>To create or join a match, use the terminal interface.</li>
        <li>The match will be established between local clients.</li>
        <li>Declare the winner using the terminal menu.</li>
      </ul>
      <p class="text-muted"><i class="bi bi-shield-check"></i> Match history and scores are recorded securely.</p>
    </div>
  </div>
</div>

<script>
const playersList = document.getElementById("players-list");
const pendingList = document.getElementById("pending-list");
const scoresList = document.getElementById("scores-list");
const historyList = document.getElementById("history-list");
const globalStats = document.getElementById("global-stats");

function loadPlayers() {
  fetch("/players")
    .then(res => res.json())
    .then(data => {
      playersList.innerHTML = data.map(p => `
        <div class="list-group-item">
          <strong>${p.username}</strong> <small class="text-muted">(${p.ip}:${p.port})</small>
        </div>`).join('');
    });
}

function loadScoresHistoryStats() {
  fetch("/scores_history").then(r => r.json()).then(data => {
    scoresList.innerHTML = data.scores.map(s =>
      `<div class="list-group-item">${s[0]} : <strong>${s[1]}</strong> points</div>`
    ).join('');

    historyList.innerHTML = data.history.map(h =>
      `<div class="list-group-item">${h.timestamp} â€” ${h.player1} vs ${h.player2} âžœ
      <strong>${h.winner || "<i>Pending</i>"}</strong></div>`
    ).join('');
  });

  fetch("/stats").then(r => r.json()).then(data => {
    globalStats.innerHTML = `
      <div class="list-group-item">Total matches: <strong>${data.total_matches}</strong></div>
      <div class="list-group-item">Average match duration: <strong>${data.avg_duration.toFixed(2)} sec</strong></div>
      ${Object.entries(data.win_percentages).map(([p, pct]) =>
        `<div class="list-group-item">${p} : ${pct.toFixed(1)}% win rate</div>`
      ).join('')}
    `;
  });
}

function loadPendingMatches() {
  fetch("/pending_matches")
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      pendingList.innerHTML = data.map(p => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <span><strong>${p.creator}</strong> waiting on code <code>${p.code}</code></span>
          <span class="text-muted small">Created ${new Date(p.created_at).toLocaleTimeString()}</span>
        </div>
      `).join('') || `<div class="list-group-item text-muted">No matches waiting.</div>`;
    });
}

// Initial load and periodic refresh
loadPlayers();
loadScoresHistoryStats();
loadPendingMatches();
setInterval(() => {
  loadPlayers();
  loadScoresHistoryStats();
  loadPendingMatches();
}, 5000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
